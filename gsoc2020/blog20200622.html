<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><meta name="generator" content="sphinx-3.3.0, furo 2020.11.01.beta14"/>
        <title>The Wonderful Wizard of O’zip - Raphael McSinyx</title>
      <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../_static/pygments_dark.css" />
    <link rel="stylesheet" type="text/css" href="../_static/fab.css" />
    <link rel="stylesheet" href="../_static/styles/default.css?714901ec90a696e26bb6b939">
    <link rel="stylesheet" href="../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
  }
</style>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/scripts/main.js?714901ec90a696e26bb6b939"></script></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>


<div class="page">
  <header class="mobile-header">
    <label class="header-left nav-overlay-icon" for="__navigation">
      <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
    </label>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Raphael McSinyx</div></a>
    </div>
    <div class="header-right"></div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/CnX.png" alt="Logo"/>
  </div>
  
</a><form class="sidebar-search-container" method="get" action="../search.html">
  <input class="sidebar-search" placeholder="Search" name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll">
  <div class="sidebar-tree">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../works.html">Free Software Works</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../life/index.html">Meatspace Adventures</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../life/2010.html">Why the Name?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../life/2013.html">The Year after the Apocalypse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../life/2020.html">The 2020 Experience</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../math/index.html">Bootleg Lambda Calculus</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../math/conseq.html">Infinite Sequences: A Case Study in Functional Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math/system.html">System Cascade Connection</a></li>
</ul>
</li>
</ul>

  </div>
  <div id="ethical-ad-placement"></div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="the-wonderful-wizard-of-o-zip">
<h1>The Wonderful Wizard of O’zip<a class="headerlink" href="#the-wonderful-wizard-of-o-zip" title="Permalink to this headline">¶</a></h1>
<blockquote class="epigraph">
<div><p>Never give up… No one knows what’s going to happen next.</p>
</div></blockquote>
<div class="section" id="preface">
<h2>Preface<a class="headerlink" href="#preface" title="Permalink to this headline">¶</a></h2>
<p>Greetings and best wishes!  I had a lot of fun during the last week,
although admittedly nothing was really finished.  In summary,
these are the works I carried out in the last seven days:</p>
<ul class="simple">
<li><p>Finilizing <a class="reference external" href="https://github.com/pypa/pip/pull/8320">utilities for parallelization</a></p></li>
<li><p><a class="reference external" href="https://github.com/pypa/pip/pull/8467">Continuing experimenting</a>
on <a class="reference external" href="https://github.com/pypa/pip/pull/8442">using lazy wheels or dependency resolution</a></p></li>
<li><p>Polishing up <a class="reference external" href="https://github.com/pypa/pip/pull/8411">the patch</a> refactoring
<code class="docutils literal notranslate"><span class="pre">operations.prepare.prepare_linked_requirement</span></code></p></li>
<li><p>Adding <code class="docutils literal notranslate"><span class="pre">flake8-logging-format</span></code>
<a class="reference external" href="https://github.com/pypa/pip/pull/8423#issuecomment-645418725">to the linter</a></p></li>
<li><p>Splitting <a class="reference external" href="https://github.com/pypa/pip/pull/8456">the linting patch</a> from <a class="reference external" href="https://github.com/pypa/pip/pull/8332">the PR adding
the license requirement to vendor README</a></p></li>
</ul>
</div>
<div class="section" id="the-multiprocessing-dummy-wrapper">
<h2>The <code class="docutils literal notranslate"><span class="pre">multiprocessing[.dummy]</span></code> wrapper<a class="headerlink" href="#the-multiprocessing-dummy-wrapper" title="Permalink to this headline">¶</a></h2>
<p>Yes, you read it right, this is the same section as last fortnight’s blog.
My mentor Pradyun Gedam gave me a green light to have <a class="reference external" href="https://github.com/pypa/pip/pull/8411">GH-8411</a> merged
without support for Python 2 and the non-lazy map variant, which turns out
to be troublesome for multithreading.</p>
<p>The tests still needs to pass of course and the flaky tests (see failing tests
over Azure Pipeline in the past) really gave me a panic attack earlier today.
We probably need to mark them as xfail or investigate why they are
undeterministic specifically on Azure, but the real reason I was <em>all caught up
and confused</em> was that the unit tests I added mess with the cached imports
and as <code class="docutils literal notranslate"><span class="pre">pip</span></code>’s tests are run in parallel, who knows what it might affect.
I was so relieved to not discover any new set of tests made flaky by ones
I’m trying to add!</p>
</div>
<div class="section" id="the-file-like-object-mapping-zip-over-http">
<h2>The file-like object mapping ZIP over HTTP<a class="headerlink" href="#the-file-like-object-mapping-zip-over-http" title="Permalink to this headline">¶</a></h2>
<p>This is where the fun starts.  Before we dive in, let’s recall some
background information on this.  As discovered by Danny McClanahan
in <a class="reference external" href="https://github.com/pypa/pip/pull/7819">GH-7819</a>, it is possible to only download a potion of a wheel
and it’s still valid for <code class="docutils literal notranslate"><span class="pre">pip</span></code> to get the distribution’s metadata.
In the same thread, Daniel Holth suggested that one may use
HTTP range requests to specifically ask for the tail of the wheel,
where the ZIP’s central directory record as well as where usually
<code class="docutils literal notranslate"><span class="pre">dist-info</span></code> (the directory containing <code class="docutils literal notranslate"><span class="pre">METADATA</span></code>) can be found.</p>
<p>Well, <em>usually</em>.  While <span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0427"><strong>PEP 427</strong></a> does indeed recommend</p>
<blockquote>
<div><p>Archivers are encouraged to place the <code class="docutils literal notranslate"><span class="pre">.dist-info</span></code> files physically
at the end of the archive.  This enables some potentially interesting
ZIP tricks including the ability to amend the metadata without
rewriting the entire archive.</p>
</div></blockquote>
<p>one of the mentioned <em>tricks</em> is adding shared libraries to wheels
of extension modules (using e.g. <code class="docutils literal notranslate"><span class="pre">auditwheel</span></code> or <code class="docutils literal notranslate"><span class="pre">delocate</span></code>).
Thus for non-pure Python wheels, it is unlikely that the metadata
lie in the last few megabytes.  Ignoring source distributions is bad enough,
we can’t afford making an optimization that doesn’t work for extension modules,
which are still an integral part of the Python ecosystem )-:</p>
<p>But hey, the ZIP’s directory record is warrantied to be at the end of the file!
Couldn’t we do something about that?  The short answer is yes.  The long answer
is, well, yessssssss! That, plus magic provided by most operating systems,
this is what we figured out:</p>
<ol class="arabic">
<li><p>We can download a realatively small chunk at the end of the wheel
until it is recognizable as a valid ZIP file.</p></li>
<li><p>In order for the end of the archive to actually appear as the end to
<code class="docutils literal notranslate"><span class="pre">zipfile</span></code>, we feed to it an object with <code class="docutils literal notranslate"><span class="pre">seek</span></code> and <code class="docutils literal notranslate"><span class="pre">read</span></code> defined.
As navigating to the rear of the file is performed by calling <code class="docutils literal notranslate"><span class="pre">seek</span></code>
with relative offset and <code class="docutils literal notranslate"><span class="pre">whence=SEEK_END</span></code> (see <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">3</span> <span class="pre">fseek</span></code>
for more details), we are completely able to make the wheels in the cloud
to behave as if it were available locally.</p>
<img alt="../_images/cloud.gif" src="../_images/cloud.gif"/>
</li>
<li><p>For large wheels, it is better to store them in hard disks instead of memory.
For smaller ones, it is also preferable to store it as a file to avoid
(error-prony and often not really efficient) manual tracking and joining
of downloaded segments.  We only use a small potion of the wheel, however
just in case one is wonderring, we have very little control over
when <code class="docutils literal notranslate"><span class="pre">tempfile.SpooledTemporaryFile</span></code> rolls over, so the memory-disk hybrid
is not exactly working as expected.</p></li>
<li><p>With all these in mind, all we have to do is to define an intermediate object
check for local availability and download if needed on calls to <code class="docutils literal notranslate"><span class="pre">read</span></code>,
to lazily provide the data over HTTP and reduce execution time.</p></li>
</ol>
<p>The only theoretical challenge left is to keep track of downloaded intervals,
which I finally figured out after a few trials and errors.  The code
was submitted as a pull request to <code class="docutils literal notranslate"><span class="pre">pip</span></code> at <a class="reference external" href="https://github.com/pypa/pip/pull/8467">GH-8467</a>.  A more modern
(read: Python 3-only) variant was packaged and uploaded to PyPI under
the name of <a class="reference external" href="https://pypi.org/project/lazip/">lazip</a>.  I am unaware of any use case for it outside of <code class="docutils literal notranslate"><span class="pre">pip</span></code>,
but it’s certainly fun to play with d-:</p>
</div>
<div class="section" id="what-s-next">
<h2>What’s next?<a class="headerlink" href="#what-s-next" title="Permalink to this headline">¶</a></h2>
<p>I have been falling short of getting the PRs mention above merged for
quite a while.  With <code class="docutils literal notranslate"><span class="pre">pip</span></code>’s next beta coming really soon, I have to somehow
make the patches reach a certain standard and enough attention to be part of
the pre-release—beta-testing would greatly help the success of the GSoC project.
To other GSoC students and mentors reading this, I also hope your projects
to turn out successful!</p>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          
          
        </div>

        <div class="related-information">
          <span class="copyright">Copyright &copy; 2018-2020, Nguyễn Gia Phong</span> |
          Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using
          <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
          <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree">
          <ul>
<li><a class="reference internal" href="#">The Wonderful Wizard of O’zip</a><ul>
<li><a class="reference internal" href="#preface">Preface</a></li>
<li><a class="reference internal" href="#the-multiprocessing-dummy-wrapper">The <code class="docutils literal notranslate"><span class="pre">multiprocessing[.dummy]</span></code> wrapper</a></li>
<li><a class="reference internal" href="#the-file-like-object-mapping-zip-over-http">The file-like object mapping ZIP over HTTP</a></li>
<li><a class="reference internal" href="#what-s-next">What’s next?</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      
      
    </aside>
  </main>
</div>
  </body>
</html>