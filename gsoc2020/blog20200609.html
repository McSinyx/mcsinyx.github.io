<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><meta name="generator" content="sphinx-3.3.0, furo 2020.11.01.beta14"/>
        <title>Unexpected Things When You’re Expecting - Raphael McSinyx</title>
      <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../_static/pygments_dark.css" />
    <link rel="stylesheet" type="text/css" href="../_static/fab.css" />
    <link rel="stylesheet" href="../_static/styles/default.css?85b4811f39a625fe72495619">
    <link rel="stylesheet" href="../_static/pygments.css">
    <link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../_static/pygments_dark.css">
    


<style>
  :root {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #436e58;
  --color-brand-content: #436e58;
  
  }
</style>
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script><script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../_static/scripts/main.js?85b4811f39a625fe72495619"></script></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>


<div class="page">
  <header class="mobile-header">
    <label class="header-left nav-overlay-icon" for="__navigation">
      <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
    </label>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Raphael McSinyx</div></a>
    </div>
    <div class="header-right"></div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/CnX.png" alt="Logo"/>
  </div>
  
</a><form class="sidebar-search-container" method="get" action="../search.html">
  <input class="sidebar-search" placeholder="Search" name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll">
  <div class="sidebar-tree">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../works.html">Free Software Works</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../life/index.html">Meatspace Adventures</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../life/2010.html">Why the Name?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../life/2013.html">The Year after the Apocalypse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../life/2020.html">The 2020 Experience</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../math/index.html">Bootleg Lambda Calculus</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../math/conseq.html">Infinite Sequences: A Case Study in Functional Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math/system.html">System Cascade Connection</a></li>
</ul>
</li>
</ul>

  </div>
  <div id="ethical-ad-placement"></div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="unexpected-things-when-you-re-expecting">
<h1>Unexpected Things When You’re Expecting<a class="headerlink" href="#unexpected-things-when-you-re-expecting" title="Permalink to this headline">¶</a></h1>
<p>Hi everyone, I hope that you are all doing well and wishes you all good health!
The last week has not been really kind to me with a decent amount of
academic pressure (my school year is lasting until early Jully).
It would be bold to say that I have spent 10 hours working on my GSoC project
since the last check-in, let alone the 30 hours per week requirement.
That being said, there were still some discoveries that I wish to share.</p>
<div class="section" id="the-multiprocessing-dummy-wrapper">
<h2>The <code class="docutils literal notranslate"><span class="pre">multiprocessing[.dummy]</span></code> wrapper<a class="headerlink" href="#the-multiprocessing-dummy-wrapper" title="Permalink to this headline">¶</a></h2>
<p>Most of the time I spent was to finalize the multi{processing,threading}
wrapper for <code class="docutils literal notranslate"><span class="pre">map</span></code> function that submit tasks to the worker pool.
To my surprise, it is rather difficult to write something that is
not only portable but also easy to read and test.</p>
<p>By <a class="reference external" href="https://github.com/pypa/pip/pull/8320">the latest commit</a>, I realized the following:</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module was not designed for the implementation
details to be abstracted away entirely.  For example, the lazy <code class="docutils literal notranslate"><span class="pre">map</span></code>’s
could be really slow without specifying suitable chunk size
(to cut the input iterable and distribute them to workers in the pool).
By <em>suitable</em>, I mean only an order smaller than the input.  This defeats
half of the purpose of making it lazy: allowing the input to be
evaluated lazily.  Luckily, in the use case I’m aiming for, the length of
the iterable argument is small and the laziness is only needed for the output
(to pipeline download and installation).</p></li>
<li><p>Mocking <code class="docutils literal notranslate"><span class="pre">import</span></code> for testing purposes can never be pretty.  One reason
is that we (Python users) have very little control over the calls of
<code class="docutils literal notranslate"><span class="pre">import</span></code> statements and its lower-level implementation <code class="docutils literal notranslate"><span class="pre">__import__</span></code>.
In order to properly patch this built-in function, unlike for others
of the same group, we have to <code class="docutils literal notranslate"><span class="pre">monkeypatch</span></code> the name from <code class="docutils literal notranslate"><span class="pre">builtins</span></code>
(or <code class="docutils literal notranslate"><span class="pre">__builtins__</span></code> under Python 2) instead of the module that import stuff.
Furthermore, because of the special namespacing, to avoid infinite recursion
we need to alias the function to a different name for fallback.</p></li>
<li><p>To add to the problem, <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> lazily imports the fragile module
during pools creation.  Since the failure is platform-specific
(the lack of <code class="docutils literal notranslate"><span class="pre">sem_open</span></code>), it was decided to check upon the import
of the <code class="docutils literal notranslate"><span class="pre">pip</span></code>’s module.  Although the behavior is easier to reason
in human language, testing it requires invalidating cached import and
re-import the wrapper module.</p></li>
<li><p>Last but not least, I now understand the pain of keeping Python 2
compatibility that many package maintainers still need to deal with
everyday (although Python 2 has reached its end-of-life, <code class="docutils literal notranslate"><span class="pre">pip</span></code>, for
example, <a class="reference external" href="https://github.com/pypa/pip/pull/6148">will still support it for another year</a>).</p></li>
</ol>
</div>
<div class="section" id="the-change-in-direction">
<h2>The change in direction<a class="headerlink" href="#the-change-in-direction" title="Permalink to this headline">¶</a></h2>
<p>Since last week, my mentor Pradyun Gedam and I set up weekly real-time
meeting (a fancy term for video/audio chat in the worldwide quarantine
era) for the entire GSoC period. During the last session, we decided to
put parallelization of download during resolution on hold, in favor of a
more beneficial goal: <a class="reference external" href="https://github.com/pypa/pip/pull/7819">partially download the wheels during
dependency resolution</a>.</p>
<img alt="../_images/swirl.png" src="../_images/swirl.png"/>
<p>As discussed by Danny McClanahan and the maintainers of <code class="docutils literal notranslate"><span class="pre">pip</span></code>, it is feasible
to only download a few kB of a wheel to obtain enough metadata for
the resolution of dependency.  While this is only applicable to wheels
(i.e. prebuilt packages), other packaging format only make up less than 20%
of the downloads (at least on PyPI), and the figure is much less for
the most popular packages.  Therefore, this optimization alone could make
<a class="reference external" href="http://www.ei8fdb.org/thoughts/2020/05/test-pips-alpha-resolver-and-help-us-document-dependency-conflicts/">the upcoming backtracking resolver</a>’s performance par with the legacy one.</p>
<p>During the last few years, there has been a lot of effort being poured into
replacing <code class="docutils literal notranslate"><span class="pre">pip</span></code>’s current resolver that is unable to resolve conflicts.
While its correctness will be ensured by some of the most talented and
hard-working developers in the Python packaging community, from the users’
point of view, it would be better to have its performance not lagging
behind the old one.  Aside from the increase in CPU cycles for more
rigorous resolution, more I/O, especially networking operations is expected
to be performed.  This is due to <a class="reference external" href="https://github.com/pypa/pip/pull/7406#issuecomment-583891169">the lack of a standard and efficient way
to acquire the metadata</a>.  Therefore, unlike
most package managers we are familiar with, <code class="docutils literal notranslate"><span class="pre">pip</span></code> has to fetch
(and possibly build) the packages solely for dependency informations.</p>
<p>Fortunately, <span class="target" id="index-0"></span><a class="pep reference external" href="https://www.python.org/dev/peps/pep-0427#recommended-archiver-features"><strong>PEP 427#recommended-archiver-features</strong></a> recommends
package builders to place the metadata at the end of the archive.
This allows the resolver to only fetch the last few kB using
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests">HTTP range requests</a> for the relevant information.
Simply appending <code class="docutils literal notranslate"><span class="pre">Range:</span> <span class="pre">bytes=-8000</span></code> to the request header
in <code class="docutils literal notranslate"><span class="pre">pip._internal.network.download</span></code> makes the resolution process
<em>lightning</em> fast.  Of course this breaks the installation but I am confident
that it is not difficult to implement this optimization cleanly.</p>
<p>One drawback of this optimization is the compatibility.  Not every Python
package index support range requests, and it is not possible to verify
the partial wheel.  While the first case is unavoidable, for the other,
hashes checking is usually used for pinned/locked-version requirements,
thus no backtracking is done during dependency resolution.</p>
<p>Either way, before installation, the packages selected by the resolver
can be downloaded in parallel.  This warranties a larger crowd of packages,
compared to parallelization during resolution, where the number of downloads
can be as low as one during trail of different versions of the same package.</p>
<p>Unfortunately, I have not been able to do much other than
<a class="reference external" href="https://github.com/pypa/pip/pull/8411">a minor clean up</a>.  I am looking forward to accomplishing more
this week and seeing what this path will lead us too!  At the moment,
I am happy that I’m able to meet the blog deadline, at least in UTC!</p>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          
          
        </div>

        <div class="related-information">
          <span class="copyright">Copyright &copy; 2018-2020, Nguyễn Gia Phong</span> |
          Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using
          <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
          <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree">
          <ul>
<li><a class="reference internal" href="#">Unexpected Things When You’re Expecting</a><ul>
<li><a class="reference internal" href="#the-multiprocessing-dummy-wrapper">The <code class="docutils literal notranslate"><span class="pre">multiprocessing[.dummy]</span></code> wrapper</a></li>
<li><a class="reference internal" href="#the-change-in-direction">The change in direction</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      
      
    </aside>
  </main>
</div>
  </body>
</html>